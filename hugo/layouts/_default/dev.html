{{- define "main" -}}
{{- $data := .Site.Data.glasses -}}

<div class="min-h-screen bg-gray-100 p-8">
  <div class="max-w-7xl mx-auto">


    <!-- Test Controls -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Viewport Size</label>
          <select id="viewport-size" class="w-full border border-gray-300 rounded-md px-3 py-2">
            <option value="desktop">Desktop</option>
            <option value="tablet">Tablet</option>
            <option value="mobile">Mobile</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Background</label>
          <select id="background" class="w-full border border-gray-300 rounded-md px-3 py-2">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Show Info</label>
          <input type="checkbox" id="show-info" class="mr-2">
          <label for="show-info" class="text-sm text-gray-700">Display component info</label>
        </div>
      </div>
    </div>

    <!-- Component Info -->
    <div id="component-info" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 hidden">
      <h3 class="text-lg font-semibold text-blue-900 mb-2">Component Information</h3>
      <div class="text-sm text-blue-800">
        <p><strong>File:</strong> hugo/layouts/partials/glasses-megamenu.html</p>
        <p><strong>Data Source:</strong> hugo/data/glasses.yaml (megamenu section)</p>
        <p><strong>Usage:</strong> {{ partial "glasses-megamenu.html" $data.megamenu }}</p>
        <p><strong>Last Updated:</strong> {{ now.Format "2006-01-02 15:04:05" }}</p>
      </div>
    </div>

        <!-- Megamenu Component -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="border-b border-gray-200 p-4">
        <h2 class="text-xl font-semibold text-gray-900">Glasses Megamenu Component</h2>
        <p class="text-sm text-gray-600 mt-1">Testing the dropdown megamenu functionality</p>
      </div>

      <!-- Component Container -->
      <div id="megamenu-container" class="relative min-h-[500px] p-8">
        {{ partial "glasses-megamenu.html" $data.megamenu }}
      </div>
    </div>

    <!-- Debug Info -->
    <div class="mt-8 bg-gray-50 rounded-lg p-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Debug Information</h3>
      <div class="text-sm text-gray-700">
        <p><strong>Data Available:</strong> {{ if $data.megamenu }}✅ Yes{{ else }}❌ No{{ end }}</p>
        <p><strong>Sections:</strong> {{ if $data.megamenu.sections }}✅ {{ len $data.megamenu.sections }}{{ else }}❌ None{{ end }}</p>
        <p><strong>Promotional Links:</strong> {{ if $data.megamenu.promotional_links }}✅ {{ len $data.megamenu.promotional_links }}{{ else }}❌ None{{ end }}</p>
        <p><strong>Featured Products:</strong> {{ if $data.megamenu.featured_products }}✅ {{ len $data.megamenu.featured_products }}{{ else }}❌ None{{ end }}</p>
      </div>
    </div>

    <!-- Performance Monitoring -->
    <div class="mt-8 bg-green-50 rounded-lg p-4">
      <h3 class="text-lg font-semibold text-green-900 mb-2">Performance Metrics</h3>
      <div class="text-sm text-green-800">
        <p><strong>DOM Nodes:</strong> <span id="node-count">-</span></p>
        <p><strong>Render Time:</strong> <span id="render-time">-</span>ms</p>
        <p><strong>Image Load Time:</strong> <span id="image-load-time">-</span>ms</p>
        <p><strong>Memory Usage:</strong> <span id="memory-usage">-</span>KB</p>
        <p><strong>Layout Shifts:</strong> <span id="layout-shifts">-</span></p>
      </div>
      <button id="run-performance-test" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Run Performance Test
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const viewportSelect = document.getElementById('viewport-size');
  const backgroundSelect = document.getElementById('background');
  const showInfoCheckbox = document.getElementById('show-info');
  const componentInfo = document.getElementById('component-info');
  const megamenuContainer = document.getElementById('megamenu-container');

  // Viewport size control
  viewportSelect.addEventListener('change', function() {
    const container = megamenuContainer.querySelector('.container');
    if (container) {
      container.className = 'container mx-auto flex max-w-7xl flex-col gap-4 px-2 sm:flex-row';

      switch(this.value) {
        case 'mobile':
          container.classList.add('max-w-sm');
          break;
        case 'tablet':
          container.classList.add('max-w-2xl');
          break;
        case 'desktop':
          container.classList.remove('max-w-sm', 'max-w-2xl');
          break;
      }
    }
  });

  // Background control
  backgroundSelect.addEventListener('change', function() {
    const container = megamenuContainer.querySelector('.h-80');
    if (container) {
      if (this.value === 'dark') {
        container.classList.remove('bg-white');
        container.classList.add('bg-gray-900');
      } else {
        container.classList.remove('bg-gray-900');
        container.classList.add('bg-white');
      }
    }
  });

  // Show info control
  showInfoCheckbox.addEventListener('change', function() {
    componentInfo.classList.toggle('hidden', !this.checked);
  });

  // Performance monitoring
  const runPerformanceTest = document.getElementById('run-performance-test');
  const nodeCount = document.getElementById('node-count');
  const renderTime = document.getElementById('render-time');
  const imageLoadTime = document.getElementById('image-load-time');
  const memoryUsage = document.getElementById('memory-usage');
  const layoutShifts = document.getElementById('layout-shifts');

  // Count DOM nodes
  function updateNodeCount() {
    const container = megamenuContainer.querySelector('.h-80');
    if (container) {
      const nodes = container.querySelectorAll('*').length;
      nodeCount.textContent = nodes;
    }
  }

  // Measure image load times
  function measureImageLoadTime() {
    const images = megamenuContainer.querySelectorAll('img');
    let totalLoadTime = 0;
    let loadedImages = 0;

    images.forEach(img => {
      if (img.complete) {
        totalLoadTime += 0;
        loadedImages++;
      } else {
        const start = performance.now();
        img.onload = () => {
          const loadTime = performance.now() - start;
          totalLoadTime += loadTime;
          loadedImages++;
          if (loadedImages === images.length) {
            imageLoadTime.textContent = Math.round(totalLoadTime / images.length);
          }
        };
      }
    });

    if (loadedImages === images.length) {
      imageLoadTime.textContent = Math.round(totalLoadTime / images.length);
    }
  }

  // Measure memory usage
  function updateMemoryUsage() {
    if (performance.memory) {
      const used = performance.memory.usedJSHeapSize / 1024;
      memoryUsage.textContent = Math.round(used);
    }
  }

  // Layout shift monitoring
  let layoutShiftCount = 0;
  const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (entry.entryType === 'layout-shift') {
        layoutShiftCount++;
        layoutShifts.textContent = layoutShiftCount;
      }
    }
  });

  if ('PerformanceObserver' in window) {
    observer.observe({ entryTypes: ['layout-shift'] });
  }

  // Run performance test
  runPerformanceTest.addEventListener('click', function() {
    const startTime = performance.now();

    // Simulate component re-render
    const container = megamenuContainer.querySelector('.h-80');
    if (container) {
      container.style.display = 'none';
      container.offsetHeight; // Force reflow
      container.style.display = '';
    }

    const endTime = performance.now();
    renderTime.textContent = Math.round(endTime - startTime);

    updateNodeCount();
    measureImageLoadTime();
    updateMemoryUsage();
  });

  // Initial measurements
  updateNodeCount();
  measureImageLoadTime();
  updateMemoryUsage();
});
</script>
{{- end -}}
